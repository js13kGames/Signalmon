function Controls({emit:t}){const e=t=>i=>{if(t){const i=t.offsetParent.offsetLeft+32,s=t.offsetParent.offsetTop+32;document.body.onmousemove=(({clientX:e,clientY:a})=>{t.style.top=`${a-s}px`,t.style.left=`${e-i}px`}),on(document.body,"mouseup",e(null)),on(document.body,"mouseleave",e(null))}else document.body.onmousemove=null};click(__("#ball"),t=>{console.log("#ball")}),click(__("#duck"),t=>{__("#duck").setAttribute("disabled",!0);const i=document.createElement("div");i.className="duck-toy",on(i,"mousedown",e(i)),__("#app").appendChild(i)}),click(__("#bed"),e=>{t("upgrade")}),click(__("#feed"),t=>{console.log("#feed")})}function DrawService(t){let e,i=0;t.on("char:update",t=>{console.log("char:update"),this.char.state=t.asleep?"sleep":t.sad?"sad":"idle",this.char.nextFrame=0}),this.init=(t=>(e=.01*t.c.width,this.char={sprite:"char_green.png",width:50*e,height:50*e,posX:.25*t.c.width,posY:.5*t.c.height-25*e,tiles:{lu:{u0:0,v0:0,u1:1/3,v1:1/3},ld:{u0:1/3,v0:0,u1:2/3,v1:1/3},ru:{u0:2/3,v0:0,u1:1,v1:1/3},rd:{u0:0,v0:1/3,u1:1/3,v1:2/3},sad:{u0:1/3,v0:1/3,u1:2/3,v1:2/3},eat1:{u0:2/3,v0:1/3,u1:1,v1:2/3},eat2:{u0:0,v0:2/3,u1:1/3,v1:1},eat3:{u0:1/3,v0:2/3,u1:2/3,v1:1},sleep:{u0:2/3,v0:2/3,u1:1,v1:1}},states:{idle:["lu","ld","lu","ld","ru","rd","ru","rd"],sad:["sad"],sleep:["sleep"],eat:["eat1","eat2","eat3","eat2","eat3","eat2"]}},this.icons={sprite:"mood_icons.png",width:10*e,height:10*e,posX:0,posY:t.c.height-20*e,tiles:{hunger:{offsetX:.1*t.c.width,offsetY:-30*e,u0:0,v0:0,u1:.5,v1:.5},sleep:{offsetX:.1*t.c.width,offsetY:-20*e,u0:.5,v0:0,u1:1,v1:.5},mood:{offsetX:.1*t.c.width,offsetY:-10*e,u0:0,v0:.5,u1:.5,v1:1},hungerBar:{offsetX:.2*t.c.width,offsetY:-30*e,u0:.8,v0:.8,u1:.9,v1:.9},sleepBar:{offsetX:.2*t.c.width,offsetY:-20*e,u0:.8,v0:.9,u1:.9,v1:1},moodBar:{offsetX:.2*t.c.width,offsetY:-10*e,u0:.91,v0:.8,u1:1,v1:.9}}},this.wifly={sprite:"wiflies.png",width:.1*t.c.width,height:.1*t.c.width,tiles:{0:{u0:0,v0:0,u1:.5,v1:1/3},1:{u0:.5,v0:0,u1:1,v1:1/3},2:{u0:0,v0:1/3,u1:.5,v1:2/3},3:{u0:.5,v0:1/3,u1:1,v1:2/3},dead0:{u0:0,v0:2/3,u1:.5,v1:1},dead1:{u0:.5,v0:2/3,u1:1,v1:1}},states:{flying:[0,1,2,3],dead:["dead0","dead1"]}},this.buzzard={sprite:"buzzard.png",width:.1*t.c.width,height:.1*t.c.width,tiles:{0:{u0:0,v0:0,u1:1,v1:.5},1:{u0:0,v0:.5,u1:1,v1:1},dead0:{u0:0,v0:2/3,u1:.5,v1:1},dead1:{u0:.5,v0:2/3,u1:1,v1:1}}},this.items={sprite:"beds.png",width:.125*t.c.width,height:.125*t.c.width,posX:.25*t.c.width,posY:.5*t.c.height-.25*t.c.width,tiles:{bed1:{offsetY:20,u0:.25,v0:0,u1:1,v1:.25},bed2:{offsetY:20,u0:.25,v0:.25,u1:1,v1:.5},bed3:{offsetY:20,u0:.25,v0:.5,u1:1,v1:.75},bed4:{offsetY:20,u0:.25,v0:.5,u1:1,v1:.75}}},this.char.state="idle",this.char.nextFrame=0,setInterval(()=>{const{nextFrame:t,tiles:e,state:i,states:s}=this.char;this.char.nextFrame=t+1,e[s[i][t+1]]||(this.char.nextFrame=0)},500),setInterval(()=>{i++},50),Promise.all([s(this.char,t),s(this.items,t),s(this.icons,t),s(this.wifly,t),s(this.buzzard,t)])));const s=(t,e)=>new Promise((i,s)=>{const a=new Image;a.src=t.sprite,a.onload=(()=>{t.texture=TCTex(e.g,a,a.width,a.height),i()})});this.draw=((t,e)=>{if(!t)return;t.cls(),t.push(),t.trans(0,0);const{tiles:i,state:s,states:n,nextFrame:o}=this.char;this.drawBed(t,e.bedLevel),a(t,this.char,n[s][o]),a(t,this.icons,"hunger"),a(t,this.icons,"sleep"),a(t,this.icons,"mood"),t.pop(),t.flush()});const a=(t,e,i)=>{if(!e.tiles[i])throw console.error(`Frame ${i} doesn't exit`),`Frame ${i} doesn't exit`;const{u0:s,v0:a,u1:n,v1:o,offsetX:r=0,offsetY:h=0}=e.tiles[i];t.img(e.texture,e.posX+r,e.posY+h,e.width,e.height,s,a,n,o)};this.drawMoodBars=((t,e)=>{t.push(),t.trans(0,0),a(t,{...this.icons,width:.7*t.c.width*e.hunger},"hungerBar"),a(t,{...this.icons,width:.7*t.c.width*e.sleep},"sleepBar"),a(t,{...this.icons,width:.7*t.c.width*e.mood},"moodBar"),t.pop(),t.flush()}),this.drawWiflies=((t,e,s)=>{t.push(),t.trans(0,0),e.forEach(({x:e,y:n},o)=>{const r=s?`dead${i%2}`:(o+i)%4;a(t,{...this.wifly,posX:e*t.c.width,posY:n*t.c.height*.4},r)}),t.pop(),t.flush()}),this.drawBuzzards=((t,e)=>{t.push(),t.trans(0,0),e.forEach(({x:e=0,y:s=0,halt:n},o)=>{const r=n?0:i%2;a(t,{...this.buzzard,posX:e*t.c.width,posY:s*t.c.height},r)}),t.pop(),t.flush()}),this.drawBed=((t,e=0)=>{e>0&&a(t,{...this.items,width:.75*t.c.width,height:.25*t.c.width,posX:.125*t.c.width,posY:.5*t.c.height-.0625*t.c.width},`bed${e}`)})}function Game(t){this.state={hunger:1,sleep:1,mood:1,buzzards:[],wiflies:[],deadWiflies:[],asleep:!1,hungry:!1,sad:!1,bedLevel:0},window.getState=(()=>this.state),window.getProps=(()=>this.hadSound);const e=()=>{const{wiflies:t,deadWiflies:i}=this.state;if(navigator.onLine&&t.length<15)t.push({x:Math.random(),y:.2*Math.random()});else if(!navigator.onLine&&t.length>0){const e=t.pop();e.isDead=!0,e.pos=1.6-(e.x-.5)**2*3*Math.random(),setTimeout(()=>i.shift(),2e3),i.push(e)}setTimeout(e,2e4*Math.random()+5e3)},i=()=>{const{wiflies:t,deadWiflies:e,buzzards:i}=this.state;this.state.wiflies=t.map(n),this.state.deadWiflies=e.map(n),this.state.buzzards=i.map(a).filter(s).sort((t,e)=>t.y>e.y)},s=t=>!(!this.hadSound&&t.x>1)||Math.random>1,a=t=>{const{x:e=0,halt:i}=t,s=i?0:.015;return{...t,halt:Math.random()<.1?!i:i,x:e>1.1?-.1:e+s}},n=t=>{const{x:e,y:i,d:s=0,isDead:a,pos:n}=t;if(a)return newDirection=Math.PI/2,{...t,y:i<n?i+.08:i};{let a=(s+Math.random())%(2*Math.PI);const n={x:.02*Math.cos(a),y:.02*Math.sin(a)};return{...t,x:e+n.x<.1||e+n.x>.9?e-n.x:e+n.x,y:i+n.y<.1||i+n.y>.9?i-n.y:i+n.y,d:a}}},o=()=>{const{wiflies:t,buzzards:e,mood:i,hunger:s,sleep:a,sad:n,asleep:o}=this.state;a<.3&&this.setState("asleep",!0),t.length>4&&(this.setState("asleep",!1),this.incState("mood",.002*-t.length)),this.incState("mood",.008*e.length),e.length>1&&this.setState("asleep",!1),(a<.2||i<.2||s<.2)&&this.setState("sad",!0),this.incState("sleep",o?.005:-.005),o&&1===a&&(this.setState("asleep",!1),this.setState("sad",!1))};this.setState=((e,i)=>{this.state[e]!==i&&(this.state[e]=i,t.emit("char:update",this.state))}),this.incState=((t,e)=>{const i=this.state[t]+e;this.state[t]=i<=.01?.01:i>=1?1:i});const r=()=>{this.state.buzzards.push({x:-0,y:.58+.1*Math.random()})},h=()=>{this.hadSound&&this.state.buzzards.length<5&&r(),this.hadSound=!1};this.init=(()=>{e(),setInterval(i,100),setInterval(o,1e3),setInterval(h,2e3),i(),t.on("upgrade",()=>{this.state.bedLevel<3&&this.state.bedLevel++}),t.on("sound",()=>{this.hadSound=!0})})}function Microphone(){let t,e,i,s,a,n,o=0;const r=()=>{e.getByteTimeDomainData(s);for(var t=0;t<i;t++)dataPoint=s[t]-128,a+=dataPoint**2,n++;requestAnimationFrame(r)},h=()=>{o=Math.round(a/n),a=0,n=0,highest=0};this.getLevel=(()=>o),this.hadSoundSpike=(()=>this.getLevel()>200),t=new window.AudioContext,(e=t.createAnalyser()).fftSize=2048,i=e.frequencyBinCount,s=new Uint8Array(i),e.getByteTimeDomainData(s),navigator.mediaDevices.getUserMedia({audio:!0}).then(i=>{t.createMediaStreamSource(i).connect(e),r(),setInterval(h,1500)})}function Events(t){var e={},i=[];(t=t||this).on=function(i,s,a){return(e[i]=e[i]||[]).push([s,a]),t},t.off=function(s,a){s||(e={});for(var n=e[s]||i,o=n.length=a?n.length:0;o--;)a==n[o][0]&&n.splice(o,1);return t},t.emit=function(s){for(var a,n=e[s]||i,o=n.length>0?n.slice(0,n.length):n,r=0;a=o[r++];)a[0].apply(a[1],i.slice.call(arguments,1));return t}}!function(){function t(t,e,i){var s=t.createShader(i);return t.shaderSource(s,e),t.compileShader(s),s}function e(e,i,s){var a=e.createProgram(),n=t(e,i,35633),o=t(e,s,35632);return e.attachShader(a,n),e.attachShader(a,o),e.linkProgram(a),a}function i(t,e,i,s){var a=t.createBuffer();return t.bindBuffer(e,a),t.bufferData(e,i,s),a}window.TCShd=t,window.TCPrg=e,window.TCBuf=i,window.TCTex=function(t,e,i,s){var a=t.createTexture();return t.bindTexture(3553,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),t.texParameteri(3553,10240,9728),t.texParameteri(3553,10241,9728),t.texImage2D(3553,0,6408,6408,5121,e),t.bindTexture(3553,null),a.width=i,a.height=s,a},window.TC=function(t){var s,a,n,o=t.getContext("webgl"),r=t.width,h=t.height,d=e(o,["precision lowp float;","attribute vec2 a, b;","attribute vec4 c;","varying vec2 d;","varying vec4 e;","uniform mat4 m;","uniform vec2 r;","void main(){","gl_Position=m*vec4(a,1.0,1.0);","d=b;","e=c;","}"].join("\n"),["precision lowp float;","varying vec2 d;","varying vec4 e;","uniform sampler2D f;","void main(){","gl_FragColor=texture2D(f,d)*e;","}"].join("\n")),u=o.bufferSubData.bind(o),c=o.drawElements.bind(o),l=o.bindTexture.bind(o),f=o.clear.bind(o),v=o.clearColor.bind(o),p=new ArrayBuffer(873760),w=new Float32Array(p),m=new Uint32Array(p),g=new Uint16Array(131064),b=i(o,34963,g.byteLength,35044),x=i(o,34962,p.byteLength,35048),y=0,S=new Float32Array([1,0,0,1,0,0]),B=new Float32Array(100),A=0,z=Math.cos,P=Math.sin,M=null,Y=null;o.blendFunc(770,771),o.enable(3042),o.useProgram(d),o.bindBuffer(34963,b);for(var T=indexB=0;T<65532;T+=6,indexB+=4)g[T+0]=indexB,g[T+1]=indexB+1,g[T+2]=indexB+2,g[T+3]=indexB+0,g[T+4]=indexB+3,g[T+5]=indexB+1;return u(34963,0,g),o.bindBuffer(34962,x),s=o.getAttribLocation(d,"a"),a=o.getAttribLocation(d,"b"),n=o.getAttribLocation(d,"c"),o.enableVertexAttribArray(s),o.vertexAttribPointer(s,2,5126,0,20,0),o.enableVertexAttribArray(a),o.vertexAttribPointer(a,2,5126,0,20,8),o.enableVertexAttribArray(n),o.vertexAttribPointer(n,4,5121,1,20,16),o.uniformMatrix4fv(o.getUniformLocation(d,"m"),0,new Float32Array([2/r,0,0,0,0,-2/h,0,0,0,0,1,1,-1,1,0,0])),o.activeTexture(33984),Y={g:o,c:t,col:4294967295,bkg:function(t,e,i){v(t,e,i,1)},cls:function(){f(16384)},trans:function(t,e){S[4]=S[0]*t+S[2]*e+S[4],S[5]=S[1]*t+S[3]*e+S[5]},scale:function(t,e){S[0]=S[0]*t,S[1]=S[1]*t,S[2]=S[2]*e,S[3]=S[3]*e},rot:function(t){var e=S[0],i=S[1],s=S[2],a=S[3],n=P(t),o=z(t);S[0]=e*o+s*n,S[1]=i*o+a*n,S[2]=e*-n+s*o,S[3]=i*-n+a*o},push:function(){B[A+0]=S[0],B[A+1]=S[1],B[A+2]=S[2],B[A+3]=S[3],B[A+4]=S[4],B[A+5]=S[5],A+=6},pop:function(){A-=6,S[0]=B[A+0],S[1]=B[A+1],S[2]=B[A+2],S[3]=B[A+3],S[4]=B[A+4],S[5]=B[A+5]},img:function(t,e,i,s,a,n,o,r,h){var d=e,f=i,v=e+s,g=i+a,b=e,x=i+a,B=e+s,A=i,z=S[0],P=S[1],T=S[2],_=S[3],L=S[4],F=S[5],X=0,D=Y.col;(t!=M||y+1>=10922)&&(u(34962,0,p),c(4,6*y,5123,0),y=0,M!=t&&l(3553,M=t)),X=20*y,w[X++]=d*z+f*T+L,w[X++]=d*P+f*_+F,w[X++]=n,w[X++]=o,m[X++]=D,w[X++]=v*z+g*T+L,w[X++]=v*P+g*_+F,w[X++]=r,w[X++]=h,m[X++]=D,w[X++]=b*z+x*T+L,w[X++]=b*P+x*_+F,w[X++]=n,w[X++]=h,m[X++]=D,w[X++]=B*z+A*T+L,w[X++]=B*P+A*_+F,w[X++]=r,w[X++]=o,m[X++]=D,++y>=10922&&(u(34962,0,p),c(4,6*y,5123,0),y=0)},flush:function(){0!=y&&(u(34962,0,w.subarray(0,20*y)),c(4,6*y,5123,0),y=0)}}}}(),window.__=(t=>document.querySelector(t)),window.on=((t,e,i)=>t.addEventListener(e,i)),window.off=((t,e)=>t.removeEventListener(e)),window.click=((t,e)=>on(t,"click",e));