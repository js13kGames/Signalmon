function Controls({emit:e}){const t=e=>i=>{if(e){const i=e.offsetParent.offsetLeft,s=e.offsetParent.offsetTop;document.body.onmousemove=(({clientX:t,clientY:n})=>{console.log("ev",n,s),e.style.top=`${n-s}px`,e.style.left=`${t-i}px`}),on(document.body,"mouseup",t(null)),on(document.body,"mouseleave",t(null))}else document.body.onmousemove=null};click(__("#ball"),e=>{console.log("#ball")}),click(__("#duck"),e=>{__("#duck").setAttribute("disabled",!0);const i=document.createElement("div");i.className="duck-toy",on(i,"mousedown",t(i)),__("#app").appendChild(i)}),click(__("#bed"),t=>{e("upgrade")}),click(__("#feed"),e=>{console.log("#feed")})}function DrawService(e){let t=0;e.on("char:update",e=>{console.log("char:update"),this.char.state=e.asleep?"sleep":e.sad?"sad":"idle",this.char.nextFrame=0}),this.init=(e=>(this.char={sprite:"char_green.png",width:.5*e.c.width,height:.5*e.c.width,posX:.25*e.c.width,posY:.5*e.c.height-.25*e.c.width,tiles:{lu:{u0:0,v0:0,u1:1/3,v1:1/3},ld:{u0:1/3,v0:0,u1:2/3,v1:1/3},ru:{u0:2/3,v0:0,u1:1,v1:1/3},rd:{u0:0,v0:1/3,u1:1/3,v1:2/3},sad:{u0:1/3,v0:1/3,u1:2/3,v1:2/3},eat1:{u0:2/3,v0:1/3,u1:1,v1:2/3},eat2:{u0:0,v0:2/3,u1:1/3,v1:1},eat3:{u0:1/3,v0:2/3,u1:2/3,v1:1},sleep:{u0:2/3,v0:2/3,u1:1,v1:1}},states:{idle:["lu","ld","lu","ld","ru","rd","ru","rd"],sad:["sad"],sleep:["sleep"],eat:["eat1","eat2","eat3","eat2","eat3","eat2"]}},this.icons={sprite:"mood_icons.png",width:.05*e.c.width,height:.05*e.c.width,posX:0,posY:e.c.height,tiles:{hunger:{offsetX:.1*e.c.width,offsetY:.45*-e.c.width,u0:0,v0:0,u1:.5,v1:.5},sleep:{offsetX:.1*e.c.width,offsetY:.35*-e.c.width,u0:.5,v0:0,u1:1,v1:.5},mood:{offsetX:.1*e.c.width,offsetY:.25*-e.c.width,u0:0,v0:.5,u1:.5,v1:1},hungerBar:{offsetX:.2*e.c.width,offsetY:.45*-e.c.width,u0:.8,v0:.8,u1:.9,v1:.9},sleepBar:{offsetX:.2*e.c.width,offsetY:.35*-e.c.width,u0:.8,v0:.9,u1:.9,v1:1},moodBar:{offsetX:.2*e.c.width,offsetY:.25*-e.c.width,u0:.9,v0:.8,u1:1,v1:.9}}},this.wifly={sprite:"wiflies.png",width:.1*e.c.width,height:.1*e.c.width,tiles:{0:{u0:0,v0:0,u1:.5,v1:1/3},1:{u0:.5,v0:0,u1:1,v1:1/3},2:{u0:0,v0:1/3,u1:.5,v1:2/3},3:{u0:.5,v0:1/3,u1:1,v1:2/3},dead0:{u0:0,v0:2/3,u1:.5,v1:1},dead1:{u0:.5,v0:2/3,u1:1,v1:1}},states:{flying:[0,1,2,3],dead:["dead0","dead1"]}},this.items={sprite:"items.png",width:.125*e.c.width,height:.125*e.c.width,posX:.25*e.c.width,posY:.5*e.c.height-.25*e.c.width,tiles:{ball:{u0:0,v0:0,u1:.25,v1:.25},duck:{u0:0,v0:.25,u1:.25,v1:.5},bed1:{offsetY:20,u0:.25,v0:0,u1:1,v1:.25},bed2:{offsetY:20,u0:.25,v0:.25,u1:1,v1:.5},bed3:{offsetY:20,u0:.25,v0:.5,u1:1,v1:.75}}},this.char.state="idle",this.char.nextFrame=0,setInterval(()=>{const{nextFrame:e,tiles:t,state:i,states:s}=this.char;this.char.nextFrame=e+1,t[s[i][e+1]]||(this.char.nextFrame=0)},500),setInterval(()=>{t++},50),Promise.all([i(this.char,e),i(this.items,e),i(this.icons,e),i(this.wifly,e)])));const i=(e,t)=>new Promise((i,s)=>{const n=new Image;n.src=e.sprite,n.onload=(()=>{e.texture=TCTex(t.g,n,n.width,n.height),i()})});this.draw=((e,t)=>{if(!e)return;e.cls(),e.push(),e.trans(0,0);const{tiles:i,state:n,states:a,nextFrame:o}=this.char;this.drawBed(e,t.bedLevel),s(e,this.char,a[n][o]),s(e,this.icons,"hunger"),s(e,this.icons,"sleep"),s(e,this.icons,"mood"),e.pop(),e.flush()});const s=(e,t,i)=>{if(!t.tiles[i])throw console.error(`Frame ${i} doesn't exit`),`Frame ${i} doesn't exit`;const{u0:s,v0:n,u1:a,v1:o,offsetX:r=0,offsetY:d=0}=t.tiles[i];e.img(t.texture,t.posX+r,t.posY+d,t.width,t.height,s,n,a,o)};this.drawMoodBars=((e,t)=>{e.push(),e.trans(0,0),s(e,{...this.icons,width:.7*e.c.width*t.hunger},"hungerBar"),s(e,{...this.icons,width:.7*e.c.width*t.sleep},"sleepBar"),s(e,{...this.icons,width:.7*e.c.width*t.mood},"moodBar"),e.pop(),e.flush()}),this.drawWiflies=((e,i,n)=>{e.push(),e.trans(0,0),i.forEach(({x:i,y:a},o)=>{const r=n?`dead${t%2}`:(o+t)%4;s(e,{...this.wifly,posX:i*e.c.width,posY:a*e.c.height*.4},r)}),e.pop(),e.flush()}),this.drawBed=((e,t=0)=>{t>0&&s(e,{...this.items,width:.75*e.c.width,height:.25*e.c.width,posX:.125*e.c.width,posY:.5*e.c.height-.0625*e.c.width},`bed${t}`)})}function Game(e){this.state={hunger:1,sleep:1,mood:1,wiflies:[],deadWiflies:[],asleep:!1,hungry:!1,sad:!1,bedLevel:0};const t=()=>{const{wiflies:e,deadWiflies:i}=this.state;if(navigator.onLine&&e.length<15)e.push({x:Math.random(),y:.2*Math.random()});else if(e.length>0){const t=e.pop();t.isDead=!0,t.pos=1.6-(t.x-.5)**2*3*Math.random(),i.push(t)}setTimeout(t,2e4*Math.random()+5e3)},i=()=>{const{wiflies:e,deadWiflies:t}=this.state;this.state.wiflies=e.map(s),this.state.deadWiflies=t.map(s)},s=e=>{const{x:t,y:i,d:s=0,isDead:n,pos:a}=e;if(n)return newDirection=Math.PI/2,{...e,y:i<a?i+.08:i};{let n=(s+Math.random())%(2*Math.PI);const a={x:.02*Math.cos(n),y:.02*Math.sin(n)};return{...e,x:t+a.x<.1||t+a.x>.9?t-a.x:t+a.x,y:i+a.y<.1||i+a.y>.9?i-a.y:i+a.y,d:n}}},n=()=>{const{wiflies:e,mood:t,hunger:i,sleep:s,sad:n,asleep:a}=this.state;s<.3&&this.setState("asleep",!0),e.length>4&&(this.setState("asleep",!1),this.incState("mood",.002*-e.length)),(s<.2||t<.2||i<.2)&&this.setState("sad",!0),this.incState("sleep",a?.005:-.005),a&&1===s&&(this.setState("asleep",!1),this.setState("sad",!1))};this.setState=((t,i)=>{this.state[t]!==i&&(this.state[t]=i,e.emit("char:update",this.state))}),this.incState=((e,t)=>{const i=this.state[e]+t;this.state[e]=i<=.01?.01:i>=1?1:i}),this.init=(()=>{t(),setInterval(i,100),setInterval(n,1e3),i(),e.on("upgrade",()=>{this.state.bedLevel<3&&this.state.bedLevel++})})}function Microphone(){let e,t,i,s,n,a,o=0;const r=()=>{t.getByteTimeDomainData(s);for(var e=0;e<i;e++)dataPoint=s[e]-128,n+=dataPoint**2,a++;requestAnimationFrame(r)},d=()=>{o=Math.round(n/a),n=0,a=0,highest=0};this.getLevel=(()=>o),e=new window.AudioContext,(t=e.createAnalyser()).fftSize=2048,i=t.frequencyBinCount,s=new Uint8Array(i),t.getByteTimeDomainData(s),navigator.mediaDevices.getUserMedia({audio:!0}).then(i=>{e.createMediaStreamSource(i).connect(t),r(),setInterval(d,1500)})}function Events(e){var t={},i=[];(e=e||this).on=function(i,s,n){return(t[i]=t[i]||[]).push([s,n]),e},e.off=function(s,n){s||(t={});for(var a=t[s]||i,o=a.length=n?a.length:0;o--;)n==a[o][0]&&a.splice(o,1);return e},e.emit=function(s){for(var n,a=t[s]||i,o=a.length>0?a.slice(0,a.length):a,r=0;n=o[r++];)n[0].apply(n[1],i.slice.call(arguments,1));return e}}!function(){function e(e,t,i){var s=e.createShader(i);return e.shaderSource(s,t),e.compileShader(s),s}function t(t,i,s){var n=t.createProgram(),a=e(t,i,35633),o=e(t,s,35632);return t.attachShader(n,a),t.attachShader(n,o),t.linkProgram(n),n}function i(e,t,i,s){var n=e.createBuffer();return e.bindBuffer(t,n),e.bufferData(t,i,s),n}window.TCShd=e,window.TCPrg=t,window.TCBuf=i,window.TCTex=function(e,t,i,s){var n=e.createTexture();return e.bindTexture(3553,n),e.texParameteri(3553,10242,33071),e.texParameteri(3553,10243,33071),e.texParameteri(3553,10240,9728),e.texParameteri(3553,10241,9728),e.texImage2D(3553,0,6408,6408,5121,t),e.bindTexture(3553,null),n.width=i,n.height=s,n},window.TC=function(e){var s,n,a,o=e.getContext("webgl"),r=e.width,d=e.height,h=t(o,["precision lowp float;","attribute vec2 a, b;","attribute vec4 c;","varying vec2 d;","varying vec4 e;","uniform mat4 m;","uniform vec2 r;","void main(){","gl_Position=m*vec4(a,1.0,1.0);","d=b;","e=c;","}"].join("\n"),["precision lowp float;","varying vec2 d;","varying vec4 e;","uniform sampler2D f;","void main(){","gl_FragColor=texture2D(f,d)*e;","}"].join("\n")),c=o.bufferSubData.bind(o),u=o.drawElements.bind(o),l=o.bindTexture.bind(o),f=o.clear.bind(o),v=o.clearColor.bind(o),w=new ArrayBuffer(873760),m=new Float32Array(w),p=new Uint32Array(w),g=new Uint16Array(131064),b=i(o,34963,g.byteLength,35044),x=i(o,34962,w.byteLength,35048),y=0,B=new Float32Array([1,0,0,1,0,0]),A=new Float32Array(100),S=0,P=Math.cos,_=Math.sin,M=null,T=null;o.blendFunc(770,771),o.enable(3042),o.useProgram(h),o.bindBuffer(34963,b);for(var Y=indexB=0;Y<65532;Y+=6,indexB+=4)g[Y+0]=indexB,g[Y+1]=indexB+1,g[Y+2]=indexB+2,g[Y+3]=indexB+0,g[Y+4]=indexB+3,g[Y+5]=indexB+1;return c(34963,0,g),o.bindBuffer(34962,x),s=o.getAttribLocation(h,"a"),n=o.getAttribLocation(h,"b"),a=o.getAttribLocation(h,"c"),o.enableVertexAttribArray(s),o.vertexAttribPointer(s,2,5126,0,20,0),o.enableVertexAttribArray(n),o.vertexAttribPointer(n,2,5126,0,20,8),o.enableVertexAttribArray(a),o.vertexAttribPointer(a,4,5121,1,20,16),o.uniformMatrix4fv(o.getUniformLocation(h,"m"),0,new Float32Array([2/r,0,0,0,0,-2/d,0,0,0,0,1,1,-1,1,0,0])),o.activeTexture(33984),T={g:o,c:e,col:4294967295,bkg:function(e,t,i){v(e,t,i,1)},cls:function(){f(16384)},trans:function(e,t){B[4]=B[0]*e+B[2]*t+B[4],B[5]=B[1]*e+B[3]*t+B[5]},scale:function(e,t){B[0]=B[0]*e,B[1]=B[1]*e,B[2]=B[2]*t,B[3]=B[3]*t},rot:function(e){var t=B[0],i=B[1],s=B[2],n=B[3],a=_(e),o=P(e);B[0]=t*o+s*a,B[1]=i*o+n*a,B[2]=t*-a+s*o,B[3]=i*-a+n*o},push:function(){A[S+0]=B[0],A[S+1]=B[1],A[S+2]=B[2],A[S+3]=B[3],A[S+4]=B[4],A[S+5]=B[5],S+=6},pop:function(){S-=6,B[0]=A[S+0],B[1]=A[S+1],B[2]=A[S+2],B[3]=A[S+3],B[4]=A[S+4],B[5]=A[S+5]},img:function(e,t,i,s,n,a,o,r,d){var h=t,f=i,v=t+s,g=i+n,b=t,x=i+n,A=t+s,S=i,P=B[0],_=B[1],Y=B[2],F=B[3],L=B[4],D=B[5],X=0,C=T.col;(e!=M||y+1>=10922)&&(c(34962,0,w),u(4,6*y,5123,0),y=0,M!=e&&l(3553,M=e)),X=20*y,m[X++]=h*P+f*Y+L,m[X++]=h*_+f*F+D,m[X++]=a,m[X++]=o,p[X++]=C,m[X++]=v*P+g*Y+L,m[X++]=v*_+g*F+D,m[X++]=r,m[X++]=d,p[X++]=C,m[X++]=b*P+x*Y+L,m[X++]=b*_+x*F+D,m[X++]=a,m[X++]=d,p[X++]=C,m[X++]=A*P+S*Y+L,m[X++]=A*_+S*F+D,m[X++]=r,m[X++]=o,p[X++]=C,++y>=10922&&(c(34962,0,w),u(4,6*y,5123,0),y=0)},flush:function(){0!=y&&(c(34962,0,m.subarray(0,20*y)),u(4,6*y,5123,0),y=0)}}}}(),window.__=(e=>document.querySelector(e)),window.on=((e,t,i)=>e.addEventListener(t,i)),window.off=((e,t)=>e.removeEventListener(t)),window.click=((e,t)=>on(e,"click",t));